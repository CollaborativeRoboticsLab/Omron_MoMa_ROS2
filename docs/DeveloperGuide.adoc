
= MoMa ROS 2 - Developer Guide
:site-section: DeveloperGuide
:toc:
:toclevels: 3
:toc-title: Table of Contents
:toc-placement: preamble
:icons: font
:sectnums:
:imagesDir: images
:librariesDir:
:stylesDir: stylesheets
:xrefstyle: full
:experimental:
:linkattrs:
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:warning-caption: :warning:
endif::[]

:url-repo: https://github.com/guanyewtan/Omron_MoMa_ROS2
:url-ug: https://github.com/guanyewtan/Omron_MoMa_ROS2

Last updated: `2 July 2021` 

Authors: `Tan Guan Yew`(link:https://github.com/guanyewtan[guanyewtan]) 


== Getting Started
[[prerequisites]]
=== Prerequisites


. **Submodules**
+
This package contains 2 submodules (see link:https://git-scm.com/book/en/v2/Git-Tools-Submodules[git submodules]) and the `omron_moma` package.
+
The 2 submodules are: 
+
.. link:https://github.com/guanyewtan/Omron_TM_ROS2[Omron_TM_ROS2]
+ 
This submodule manages the TM robot, and contains packages to control and visualise the robot model in RViz.
+
.. link:https://github.com/guanyewtan/Omron_AMR_ROS2.git[Omron_AMR_ROS2]
+
This submodule manages the Autonomous Mobile Robot (AMR), and contains packages to control and visualise the robot model in RViz.

These packages can be used individually to control the TM machine and Autonomous Mobile Robot respectively, and the `omron_moma` package utilises both of them to control the Mobile Manipulator.

In order to run the `omron_moma` package, *ensure that the requirements and setup for running Omron_TM_ROS2 (link:https://github.com/guanyewtan/Omron_TM_ROS2/blob/master/docs/DeveloperGuide.adoc[Developer Guide]) and Omron_AMR_ROS2 (link:https://github.com/guanyewtan/Omron_AMR_ROS2/blob/master/docs/DeveloperGuide.adoc[Developer Guide]) have been met.*


=== Hardware Connection
The diagram below shows the hardware connection of the MoMa. 

.Hardware Connection
image::hardware_connection.png[]

The Intel NUC, AMR and TM robot are all connected to the ethernet switching hub via ethernet cable. *Ensure that the 3 machines are able to communicate with each other on the same subnet, e.g. 192.168.1.x with subnet mask 255.255.255.0.*

=== ROS2 Across Multiple Machines
The `omron_moma` package has been designed to run across 2 machine; the host machine, which runs the nodes for communication with the TM robot and the AMR, as well as the remote machine, which runs the high level scripts/clients to execute jobs on the MoMa. 

To set up ROS2 across the host and remote machine, ensure that both the remote machine and host machine are on the same subnet and are discoverable to each other.

*Also ensure that the ROS_DOMAIN_ID of both devices are the same.*


=== Set Up Host Machine
The host machine is used to run the nodes which enable communication with the TM robot via tcp and modbus communication.
It is also used to communicate with the AMR via the ARCL interface in order to retrieve vital information about the AMR that is used for this package to work.


==== Host Machine ROS 2 Package Set Up
Once you have your network set up correctly, you need to set up our ROS 2 package to work correctly in your host machine.

First, make sure you have installed ROS 2 as described in <<prerequisites>>.

. Clone this repository to a directory of your choice with: 
+
....
cd <directory>
git clone --recurse-submodules https://github.com/zach-goh/Omron_MoMa_ROS2.git
....
+
[NOTE]
If you pass --recurse-submodules to the git clone command, it will automatically initialize and update each submodule in the repository.
. Enter the folder with:
+
....
cd Omron_MoMa_ROS2
....
. Build all package and source the setup.bash file:
+
....
colcon build --symlink-install
source install/setup.bash
....
+
[NOTE]
Depending on your machine, this can take a while to build.
If you receive a warning saying "no such command", follow the intructions link:https://docs.ros.org/en/foxy/Tutorials/Colcon-Tutorial.html#install-colcon[here].
You might need to install some missing packages if you didn't already have them. They can be installed with `sudo apt install ros-foxy-control-msgs`.
+
. Run the nodes for the host machine:
+
....
ros2 launch omron_moma server.launch.py robot_ip:=<ip address of TM machine>
....
+
This will launch the nodes for communication with the TM and the AMR.


== Implementation
=== Demo Program
The omron_moma package allows the user to create a load and unload program, requiring only a one time setup. The demo program will then run a vision guided load and unload operation at 2 different goals.

*To run the demo program, ensure that:*

. The requirements in <<prerequisites>> have been met.

. `server.launch.py` has been launched on the host machine.

. There are 2 goals set for the AMR, one called 'Goal1' and the other called 'Goal2'.

. The load and unload motion has been taught. This can be done by running
+
....
ros2 run omron_moma teach_setup <ip address of TM>
....
+
[NOTE]
This teach_setup.py file *is different from the one in the pickplace package*. This one requires the user to enter the name of the goal that the pick and place motion will be carried out at. For example, if the pick and place motion is done at Goal1, the user will be prompted to enter 'Goal1' when running the setup. Everything else works the same.


==== Running the demo program

. Enter the folder with:
+
....
cd Omron_MoMa_ROS2
....
. Build all package and source the setup.bash file:
+
....
colcon build --symlink-install
source install/setup.bash
....
+
. *Make sure the TM program is running, either in auto or manual mode*
+
. Run the demo script:
+
....
ros2 run omron_moma demo <ip address of TM>
....

The MoMa should move to Goal2, execute a pick and place motion, then move to Goal1 and execute a pick and place motion.
